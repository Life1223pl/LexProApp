{% extends 'base.html.twig' %}

{% block title %}Postępowanie {{ postepowanie.numer }}{% endblock %}

{% block body %}
    <div class="container mt-4">

        <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
                <h1 class="mb-0">Postępowanie: {{ postepowanie.numer }}</h1>
                <div class="text-muted small">
                    {{ postepowanie.rodzaj }}
                </div>
            </div>

            <div class="d-flex gap-2">
                <a class="btn btn-outline-secondary" href="{{ path('app_postepowanie_index') }}">← Wróć</a>

                <a class="btn btn-outline-primary"
                   href="{{ path('app_postepowanie_osoby_index', {'id': postepowanie.id}) }}">
                    Osoby w sprawie
                </a>

                {# Edycja zablokowana, jeśli oczekuje na usunięcie (dla pracownika) #}
                {% if not (postepowanie.status == constant('App\\Entity\\Postepowanie::STATUS_WAITING_DELETE_APPROVAL') and not is_granted('ROLE_SUPERVISOR')) %}
                    <a class="btn btn-outline-secondary" href="{{ path('app_postepowanie_edit', {'id': postepowanie.id}) }}">
                        Edytuj
                    </a>
                {% endif %}
            </div>
        </div>

        {# Flashe #}
        {% for label, messages in app.flashes %}
            {% for message in messages %}
                <div class="alert alert-{{ label == 'success' ? 'success' : 'info' }}">{{ message }}</div>
            {% endfor %}
        {% endfor %}

        {# Info o oczekiwaniu na usunięcie #}
        {% if postepowanie.status == constant('App\\Entity\\Postepowanie::STATUS_WAITING_DELETE_APPROVAL') %}
            <div class="alert alert-warning">
                To postępowanie <strong>oczekuje na usunięcie</strong> (wymaga akceptacji przełożonego).
            </div>
        {% endif %}

        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title mb-3">Dane postępowania</h5>

                <div class="row g-3">
                    <div class="col-md-3">
                        <div class="text-muted small">Numer</div>
                        <div class="fw-semibold">{{ postepowanie.numer }}</div>
                    </div>

                    <div class="col-md-3">
                        <div class="text-muted small">Rodzaj</div>
                        <div class="fw-semibold">{{ postepowanie.rodzaj }}</div>
                    </div>

                    <div class="col-md-3">
                        <div class="text-muted small">Data wszczęcia</div>
                        <div class="fw-semibold">{{ postepowanie.dataWszczecia ? postepowanie.dataWszczecia|date('Y-m-d') : '-' }}</div>
                    </div>

                    <div class="col-md-3">
                        <div class="text-muted small">Data zakończenia</div>
                        <div class="fw-semibold">{{ postepowanie.dataZakonczenia ? postepowanie.dataZakonczenia|date('Y-m-d') : '-' }}</div>
                    </div>

                    <div class="col-md-3">
                        <div class="text-muted small">Status</div>
                        <div>
                            {% if postepowanie.status == constant('App\\Entity\\Postepowanie::STATUS_WAITING_DELETE_APPROVAL') %}
                                <span class="badge bg-warning text-dark">Oczekuje na usunięcie</span>
                            {% elseif postepowanie.status == constant('App\\Entity\\Postepowanie::STATUS_WAITING_APPROVAL') %}
                                <span class="badge bg-secondary">Oczekuje na zatwierdzenie</span>
                            {% elseif postepowanie.status == constant('App\\Entity\\Postepowanie::STATUS_APPROVED') %}
                                <span class="badge bg-success">Zatwierdzone</span>
                            {% elseif postepowanie.status == constant('App\\Entity\\Postepowanie::STATUS_REJECTED') %}
                                <span class="badge bg-danger">Odrzucone</span>
                            {% elseif postepowanie.status == constant('App\\Entity\\Postepowanie::STATUS_CLOSED') %}
                                <span class="badge bg-dark">Zamknięte</span>
                            {% elseif postepowanie.status == constant('App\\Entity\\Postepowanie::STATUS_DELETE_REJECTED') %}
                                <span class="badge bg-danger">Usunięcie odrzucone</span>
                            {% else %}
                                <span class="badge bg-light text-dark">{{ postepowanie.status }}</span>
                            {% endif %}
                        </div>
                    </div>

                    <div class="col-md-3">
                        <div class="text-muted small">Prowadzący</div>
                        <div class="fw-semibold">{{ postepowanie.prowadzacy }}</div>
                    </div>

                    <div class="col-md-6">
                        <div class="text-muted small">Zatwierdził</div>
                        <div class="fw-semibold">
                            {{ postepowanie.approvedBy ? postepowanie.approvedBy : '-' }}
                            {% if postepowanie.approvedAt %}
                                <span class="text-muted small">({{ postepowanie.approvedAt|date('Y-m-d H:i') }})</span>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="mt-3 d-flex gap-2 flex-wrap">
                    {# Zgłoszenie usunięcia / usuń #}
                    {% set isWaitingDelete = postepowanie.status == constant('App\\Entity\\Postepowanie::STATUS_WAITING_DELETE_APPROVAL') %}
                    <form method="post"
                          action="{{ path('app_postepowanie_delete', {'id': postepowanie.id}) }}"
                          onsubmit="return confirm('{% if is_granted('ROLE_SUPERVISOR') %}Na pewno usunąć postępowanie?{% else %}Wysłać wniosek o usunięcie do przełożonego?{% endif %}');">
                        <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ postepowanie.id) }}">
                        <button class="btn btn-outline-danger" type="submit" {% if isWaitingDelete and not is_granted('ROLE_SUPERVISOR') %}disabled{% endif %}>
                            {% if is_granted('ROLE_SUPERVISOR') %}
                                Usuń
                            {% else %}
                                {% if isWaitingDelete %}Wysłano wniosek o usunięcie{% else %}Zgłoś usunięcie{% endif %}
                            {% endif %}
                        </button>
                    </form>

                    <a class="btn btn-success"
                       href="{{ path('app_postepowanie_osoby_add', {'id': postepowanie.id}) }}">
                        + Dodaj osobę
                    </a>

                    <a class="btn btn-outline-primary"
                       href="{{ path('app_postepowanie_osoby_index', {'id': postepowanie.id}) }}">
                        Zobacz wszystkie osoby
                    </a>
                </div>
            </div>
        </div>

        {# Sekcja: Osoby w sprawie (podgląd na stronie postępowania) #}
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="card-title mb-0">Osoby w sprawie</h5>
                    <div class="d-flex gap-2">
                        <a class="btn btn-sm btn-success"
                           href="{{ path('app_postepowanie_osoby_add', {'id': postepowanie.id}) }}">
                            + Dodaj osobę
                        </a>
                        <a class="btn btn-sm btn-outline-primary"
                           href="{{ path('app_postepowanie_osoby_index', {'id': postepowanie.id}) }}">
                            Zobacz wszystkie
                        </a>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-striped table-hover align-middle mb-0">
                        <thead class="table-light">
                        <tr>
                            <th>Osoba</th>
                            <th>Rola</th>
                            <th>Pouczenie</th>
                            <th class="text-end">Akcje</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for po in postepowanie.osoby|slice(0, 5) %}
                            <tr>
                                <td class="fw-semibold">{{ po.osoba }}</td>
                                <td><span class="badge bg-primary">{{ po.rola }}</span></td>
                                <td>
                                    {% if po.pouczonyOdpowiedzialnoscKarna %}
                                        <span class="badge bg-success">TAK</span>
                                    {% else %}
                                        <span class="badge bg-secondary">NIE</span>
                                    {% endif %}
                                </td>
                                <td class="text-end">
                                    <form method="post"
                                          action="{{ path('app_postepowanie_osoby_remove', {'id': postepowanie.id, 'poId': po.id}) }}"
                                          style="display:inline-block"
                                          onsubmit="return confirm('Usunąć przypięcie tej osoby (rola w tym postępowaniu)?');">
                                        <input type="hidden" name="_token" value="{{ csrf_token('remove_po_' ~ po.id) }}">
                                        <button class="btn btn-sm btn-outline-danger">Usuń</button>
                                    </form>
                                </td>
                            </tr>
                        {% else %}
                            <tr>
                                <td colspan="4" class="text-center text-muted">Brak osób przypiętych do postępowania.</td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>

                {% if postepowanie.osoby|length > 5 %}
                    <div class="text-muted small mt-2">
                        Pokazano 5 z {{ postepowanie.osoby|length }} osób.
                    </div>
                {% endif %}
            </div>
        </div>

    </div>
{% endblock %}
